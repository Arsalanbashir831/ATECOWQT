<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Operator PERFORMANCE QUALIFICATION TEST RECORD</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.4;
      background-color: #f4f4f4;
    }

    .form-container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 1000px;
      margin: auto;
    }

    h1 {
      text-align: center;
      color: #333;
      text-transform: uppercase;
      margin-bottom: 20px;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }

    .section {
      margin-bottom: 25px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
    }

    .section-title {
      font-weight: bold;
      background: #eee;
      padding: 8px;
      margin: -15px -15px 15px -15px;
      border-bottom: 1px solid #ddd;
      text-transform: uppercase;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    input[type="text"],
    input[type="date"],
    input[type="file"],
    select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .test-table,
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .test-table th,
    .test-table td,
    .data-table th,
    .data-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .test-table th,
    .data-table th {
      background: #f9f9f9;
    }

    .submit-btn {
      background-color: #28a745;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      display: block;
      margin: 20px auto;
    }

    .submit-btn:hover {
      background-color: #218838;
    }

    .cancel-btn {
      background-color: #6c757d;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      display: inline-block;
      margin: 20px 10px;
      text-decoration: none;
    }

    .cancel-btn:hover {
      background-color: #5a6268;
    }

    .photo-preview {
      width: 150px;
      height: 150px;
      border: 2px dashed #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      overflow: hidden;
    }

    .photo-preview img {
      max-width: 100%;
      max-height: 100%;
    }

    .current-photo {
      max-width: 150px;
      max-height: 150px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .button-group {
      text-align: center;
    }

    @media print {
      .hide-in-print {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="form-container">
    <h1>Edit Operator PERFORMANCE QUALIFICATION TEST RECORD</h1>

    <form action="/operator/update/<%= record.operatorNo %>" method="POST" enctype="multipart/form-data">
      <div class="section">
        <div class="section-title">Operator Identification</div>
        <div class="form-grid">
          <div class="form-group">
            <label for="clientName">Client Name:</label>
            <input type="text" id="clientName" name="clientName" value="<%= record.clientName || '' %>"
              placeholder="Enter Client Name">
          </div>
          <div class="form-group">
            <label for="operatorName">Operator Name:</label>
            <input type="text" id="operatorName" name="operatorName" value="<%= record.operatorName || '' %>" required>
          </div>
          <div class="form-group">
            <label for="operatorId">Clock No / Identification No:</label>
            <input type="text" id="operatorId" name="operatorId" value="<%= record.operatorId || '' %>">
          </div>
          <div class="form-group">
            <label for="iqamaPassport">Iqama / Passport No:</label>
            <input type="text" id="iqamaPassport" name="iqamaPassport" value="<%= record.iqamaPassport || '' %>">
          </div>
          <div class="form-group">
            <label for="certificateNo">Certificate No:</label>
            <input type="text" id="certificateNo" name="certificateNo" value="<%= record.certificateNo || '' %>" readonly
              style="color: green; font-weight: bold;">
          </div>
          <div class="form-group">
            <label>Current Profile Photo:</label>
            <% if (record.profilePic) { %>
              <img src="<%= record.profilePic %>" alt="Current Photo" class="current-photo">
              <% } %>
                <label for="profile">Upload New Photo (Optional):</label>
                <input type="file" id="profile" name="profile" accept="image/*">
                <div class="photo-preview">
                  <img id="photoPreview" alt="Photo Preview" style="display: none;">
                  <span id="previewPlaceholder">Preview</span>
                </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Test Coupon Description</div>
        <div class="form-grid">
          <div class="form-group"><label>WPS Followed:</label><input type="text" name="wpsFollowed"
              value="<%= record.wpsFollowed || '' %>"></div>
          <div class="form-group"><label>Joint Weld Type:</label><input type="text" name="jointWeldType"
              value="<%= record.jointWeldType || '' %>"></div>
          <div class="form-group"><label>Base Metal Specification:</label><input type="text" name="baseMetalSpec"
              value="<%= record.baseMetalSpec || '' %>"></div>
          <div class="form-group"><label>Base Metal P-Number:</label><input type="text" name="baseMetalPNo"
              value="<%= record.baseMetalPNo || '' %>"></div>
          <div class="form-group"><label>Test Coupon Size:</label><input type="text" name="testCouponSize"
              value="<%= record.testCouponSize || '' %>"></div>
          <div class="form-group"><label>Filler SFA Spec:</label><input type="text" name="fillerSfaSpec"
              value="<%= record.fillerSfaSpec || '' %>"></div>
          <div class="form-group"><label>Filler Class AWS:</label><input type="text" name="fillerClassAws"
              value="<%= record.fillerClassAws || '' %>"></div>
          <div class="form-group"><label>Positions:</label><input type="text" name="positions"
              value="<%= record.positions || '' %>"></div>
          <div class="form-group"><label>Date of Welding:</label><input type="date" name="dateOfWelding"
              value="<%= record.dateOfWelding || '' %>"></div>
          <div class="form-group"><label>Date of Issue:</label><input type="date" name="dateOfIssue"
              value="<%= record.dateOfIssue || '' %>"></div>
        </div>
      </div>

      <div class="section">
        <div style="font-weight: bold; margin-bottom: 10px;">Testing Variables and Qualification Limits When Using
          Automatic Welding Equipment</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Welding variables</th>
              <th>Actual Values</th>
              <th>Range Qualified</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Type of Welding (Automatic)</td>
              <td><input type="text" name="typeOfWeldingAutomaticActual"
                  value="<%= record.typeOfWeldingAutomaticActual || '' %>"></td>
              <td><input type="text" name="typeOfWeldingAutomaticRange"
                  value="<%= record.typeOfWeldingAutomaticRange || '' %>"></td>
            </tr>
            <tr>
              <td>Welding Process</td>
              <td><input type="text" name="weldingProcessAutomaticActual"
                  value="<%= record.weldingProcessAutomaticActual || '' %>"></td>
              <td><input type="text" name="weldingProcessAutomaticRange"
                  value="<%= record.weldingProcessAutomaticRange || '' %>"></td>
            </tr>
            <tr>
              <td>Filler Metal Used (GTAW/PAW)</td>
              <td><input type="text" name="fillerMetalUsedActual" value="<%= record.fillerMetalUsedActual || '' %>">
              </td>
              <td><input type="text" name="fillerMetalUsedRange" value="<%= record.fillerMetalUsedRange || '' %>"></td>
            </tr>
            <tr>
              <td>Type of laser (LBW)</td>
              <td><input type="text" name="typeOfLaserActual" value="<%= record.typeOfLaserActual || '' %>"></td>
              <td><input type="text" name="typeOfLaserRange" value="<%= record.typeOfLaserRange || '' %>"></td>
            </tr>
            <tr>
              <td>Countinous Drive or Inertia (FW)</td>
              <td><input type="text" name="countinousDriveActual" value="<%= record.countinousDriveActual || '' %>">
              </td>
              <td><input type="text" name="countinousDriveRange" value="<%= record.countinousDriveRange || '' %>"></td>
            </tr>
            <tr>
              <td>Vacuum or Out of Vacuum (EBW)</td>
              <td><input type="text" name="vacuumOutOfVacuumActual" value="<%= record.vacuumOutOfVacuumActual || '' %>">
              </td>
              <td><input type="text" name="vacuumOutOfVacuumRange" value="<%= record.vacuumOutOfVacuumRange || '' %>">
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="section">
        <div style="font-weight: bold; margin-bottom: 10px;">Testing Variables and Qualification Limits When Using
          Machine Welding Equipment</div>
        <table class="data-table" id="machineVariablesTable">
          <thead>
            <tr>
              <th>Welding Variables</th>
              <th>Actual Values</th>
              <th>Range Qualified</th>
              <th class="hide-in-print">Action</th>
            </tr>
          </thead>
          <tbody id="machineVariablesBody"></tbody>
        </table>
        <div class="hide-in-print"><button type="button" onclick="addMachineRow()"
            style="background-color: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">+
            Add Variable Row</button></div>
      </div>

      <div class="section">
        <div class="section-title">Type of Qualification Test</div>
        <table class="test-table">
          <thead>
            <tr>
              <th>Type of Test</th>
              <th>Performed</th>
              <th>Results</th>
              <th>Report Number</th>
            </tr>
          </thead>
          <tbody>
            <% const tests=['visualExamination', 'liquidPenetrantExamination' , 'ultrasonicTesting' , 'bendTest'
              , 'radiographicExamination' ]; %>
              <% const labels=['Visual Inspection', 'Liquid Penetrant (PT)' , 'Ultrasonic Testing (UT)' , 'Bend Test'
                , 'Radiographic (RT)' ]; %>
                <% tests.forEach((test, i)=> { %>
                  <tr>
                    <td>
                      <%= labels[i] %>
                    </td>
                    <td><input type="checkbox" name="<%= test %>[performed]" value="true" <%=record[test] &&
                        record[test].performed ? 'checked' : '' %>></td>
                    <td><input type="text" name="<%= test %>[results]"
                        value="<%= record[test] && record[test].results || '' %>"></td>
                    <td><input type="text" name="<%= test %>[reportNumber]"
                        value="<%= record[test] && record[test].reportNumber || '' %>"></td>
                  </tr>
                  <% }); %>
          </tbody>
        </table>
      </div>

      <div class="section">
        <div class="section-title">Certification & Signatures</div>
        <div class="form-grid">
          <div class="form-group"><label>Testing Witnessed / Inspector:</label><input type="text" name="witnessedBy"
              value="<%= record.witnessedBy || '' %>"></div>
          <div class="form-group"><label>Supervisor / Manager:</label><input type="text" name="supervisorName"
              value="<%= record.supervisorName || '' %>"></div>
        </div>
        <div style="margin-top:10px;"><label>Certified in accordance with:</label><input type="text" name="lawName"
            value="<%= record.lawName || '' %>" required style="width: 100%;"></div>
      </div>

      <div class="button-group hide-in-print">
        <button type="submit" class="submit-btn">Update Certificate</button>
        <a href="/operator/view/<%= record.operatorNo %>" class="cancel-btn">Cancel</a>
      </div>
    </form>
  </div>

  <div id="serverData" style="display: none;"
    data-machine-variables="<%= JSON.stringify(record.machineVariables || []).replace(/" /g, '&quot;' ) %>"
    data-legacy-type-actual="<%= (record.typeOfWeldingMachineActual || record.typeOfWeldingMachine || ''
      ).replace(/"/g, '&quot;' ) %>"
      data-legacy-type-range="<%= (record.typeOfWeldingMachineRange || '' ).replace(/"/g, '&quot;' ) %>"
        data-legacy-proc-actual="<%= (record.weldingProcessMachineActual || record.weldingProcessMachine || ''
          ).replace(/"/g, '&quot;' ) %>"
          data-legacy-proc-range="<%= (record.weldingProcessMachineRange || '' ).replace(/"/g, '&quot;' ) %>"
            data-legacy-vis-actual="<%= (record.directRemoteVisualControlActual || record.directRemoteVisualControl
              || '' ).replace(/"/g, '&quot;' ) %>"
              data-legacy-vis-range="<%= (record.directRemoteVisualControlRange || '' ).replace(/"/g, '&quot;' ) %>"
                data-legacy-arc-actual="<%= (record.automaticArcVoltageControlActual ||
                  record.automaticArcVoltageControl || '' ).replace(/"/g, '&quot;' ) %>"
                  data-legacy-arc-range="<%= (record.automaticArcVoltageControlRange || '' ).replace(/"/g, '&quot;' ) %>
                    "
                    data-legacy-joint-actual="<%= (record.automaticJointTrackingActual || record.automaticJointTracking
                      || '' ).replace(/"/g, '&quot;' ) %>"
                      data-legacy-joint-range="<%= (record.automaticJointTrackingRange || '' ).replace(/"/g, '&quot;' )
                        %>"
                        data-legacy-pos-actual="<%= (record.positionsMachineActual || record.positionsMachine || ''
                          ).replace(/"/g, '&quot;' ) %>"
                          data-legacy-pos-range="<%= (record.positionsMachineRange || '' ).replace(/"/g, '&quot;' ) %>"
                            data-legacy-thick-actual="<%= (record.baseMaterialThicknessActual ||
                              record.baseMaterialThickness || '' ).replace(/"/g, '&quot;' ) %>"
                              data-legacy-thick-range="<%= (record.baseMaterialThicknessRange || ''
                                ).replace(/"/g, '&quot;' ) %>"
                                data-legacy-insert-actual="<%= (record.consumableInsertActual || record.consumableInsert
                                  || '' ).replace(/"/g, '&quot;' ) %>"
                                  data-legacy-insert-range="<%= (record.consumableInsertRange || ''
                                    ).replace(/"/g, '&quot;' ) %>"
                                    data-legacy-backing-actual="<%= (record.backingActual || record.backing || ''
                                      ).replace(/"/g, '&quot;' ) %>"
                                      data-legacy-backing-range="<%= (record.backingRange || '' ).replace(/"/g, '&quot;'
                                        ) %>"
                                        data-legacy-passes-actual="<%= (record.singleMultiplePassesActual ||
                                          record.singleMultiplePasses || '' ).replace(/"/g, '&quot;' ) %>"
                                          data-legacy-passes-range="<%= (record.singleMultiplePassesRange || ''
                                            ).replace(/"/g, '&quot;' ) %>">
  </div>

  <script>
    document.getElementById('profile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.getElementById('photoPreview');
          const placeholder = document.getElementById('previewPlaceholder');
          preview.src = e.target.result;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
      }
    });

    const machineVariablesBody = document.getElementById('machineVariablesBody');
    function escapeHtml(str) { return !str ? '' : String(str).replace(/"/g, '&quot;'); }

    function addMachineRow(label, actual, range) {
      const rowCount = machineVariablesBody.rows.length;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" name="machineVariables[${rowCount}][label]" value="${escapeHtml(label || '')}"></td>
        <td><input type="text" name="machineVariables[${rowCount}][actualValue]" value="${escapeHtml(actual || '')}"></td>
        <td><input type="text" name="machineVariables[${rowCount}][rangeQualified]" value="${escapeHtml(range || '')}"></td>
        <td class="hide-in-print"><button type="button" onclick="this.closest('tr').remove(); reindexRows()" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Remove</button></td>
      `;
      machineVariablesBody.appendChild(row);
      reindexRows();
    }

    function reindexRows() {
      Array.from(machineVariablesBody.rows).forEach((row, index) => {
        row.querySelectorAll('input').forEach(input => {
          input.name = input.name.replace(/\[\d+\]/, '[' + index + ']');
        });
      });
    }

    (function () {
      const init = () => {
        const el = document.getElementById('serverData');
        if (!el) return;
        let data = [];
        try { data = JSON.parse(el.getAttribute('data-machine-variables') || '[]'); } catch (e) { }

        if (data.length > 0) {
          data.forEach(v => addMachineRow(v.label, v.actualValue, v.rangeQualified));
        } else {
          const g = (k) => el.getAttribute('data-legacy-' + k) || '';
          addMachineRow('Type of Welding (Machine)', g('type-actual'), g('type-range'));
          addMachineRow('Welding Process', g('proc-actual'), g('proc-range'));
          addMachineRow('Direct or Remote Visual Control', g('vis-actual'), g('vis-range'));
          addMachineRow('Automatic Arc Voltage Control (GTAW)', g('arc-actual'), g('arc-range'));
          addMachineRow('Automatic Joint Tracking', g('joint-actual'), g('joint-range'));
          addMachineRow('Position(s)', g('pos-actual'), g('pos-range'));
          addMachineRow('Base Material Thickness', g('thick-actual'), g('thick-range'));
          addMachineRow('Consumable Insert (GTAW or PAW)', g('insert-actual'), g('insert-range'));
          addMachineRow('Backing (With or Without)', g('backing-actual'), g('backing-range'));
          addMachineRow('Single or Multiple Passes Per Side', g('passes-actual'), g('passes-range'));
        }
      };
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
      else init();
    })();
  </script>
</body>

</html>